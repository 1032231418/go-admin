<section class="content-header">
    <h1>
        菜单管理
        <small>菜单管理</small>
    </h1>
</section>
<section class="content">
    <div class="row">
        <div class="col-md-6">
            <div class="box">
                <div class="box-header">
                    <div class="btn-group">
                        <a class="btn btn-primary btn-sm tree-5b405b7481760-tree-tools" data-action="expand">
                            <i class="fa fa-plus-square-o"></i>&nbsp;Expand
                        </a>
                        <a class="btn btn-primary btn-sm tree-5b405b7481760-tree-tools" data-action="collapse">
                            <i class="fa fa-minus-square-o"></i>&nbsp;Collapse
                        </a>
                    </div>

                    <div class="btn-group">
                        <a class="btn btn-info btn-sm  tree-5b405b7481760-save"><i class="fa fa-save"></i>&nbsp;Save</a>
                    </div>

                    <div class="btn-group">
                        <a class="btn btn-warning btn-sm tree-5b405b7481760-refresh"><i class="fa fa-refresh"></i>&nbsp;Refresh</a>
                    </div>
                    <div class="btn-group">
                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body table-responsive no-padding">
                    <div class="dd" id="tree-5b405b7481760">
                        <ol class="dd-list">
                            <%@ menuEditpart { %>
                            <% } %>
                        </ol>
                    </div>
                </div>
                <!-- /.box-body -->
            </div>
        </div>
        <div class="col-md-6">
            <div class="box box-success">
                <div class="box-header with-border">
                    <h3 class="box-title">New</h3>
                    <div class="box-tools pull-right">
                    </div>
                    <!-- /.box-tools -->
                </div>
                <!-- /.box-header -->
                <div class="box-body" style="display: block;">
                    <form method="POST" action="/menu/new" class="form-horizontal" accept-charset="UTF-8"
                          pjax-container="1">
                        <div class="box-body fields-group">
                            <div class="form-group  ">
                                <label for="parent_id" class="col-sm-2 control-label">Parent</label>
                                <div class="col-sm-8">
                                    <input type="hidden" name="parent_id"><select
                                        class="form-control parent_id select2-hidden-accessible" style="width: 100%;"
                                        name="parent_id" tabindex="-1" aria-hidden="true">
                                    <option value=""></option>
                                    <option value="0" selected="">Root</option>
                                    <%@ optionPart { %>
                                    <% } %>
                                </select>
                                </div>
                            </div>

                            <div class="form-group  ">

                                <label for="title" class="col-sm-2 control-label">Title</label>

                                <div class="col-sm-8">


                                    <div class="input-group">

                                        <span class="input-group-addon"><i class="fa fa-pencil fa-fw"></i></span>

                                        <input type="text" id="title" name="title" value="" class="form-control title"
                                               placeholder="Input Title">
                                    </div>


                                </div>
                            </div>
                            <div class="form-group">

                                <label for="icon" class="col-sm-2 control-label">Icon</label>

                                <div class="col-sm-8">


                                    <div class="input-group iconpicker-container">

                                        <span class="input-group-addon"><i class="fa fa-bars"></i></span>

                                        <input style="width: 140px" type="text" id="icon" name="icon" value="fa-bars"
                                               class="form-control icon iconpicker-element iconpicker-input"
                                               placeholder="Input Icon">
                                    </div>

                                    <span class="help-block">
<i class="fa fa-info-circle"></i>&nbsp;For more icons please see <a href="http://fontawesome.io/icons/" target="_blank">http://fontawesome.io/icons/</a>
</span>

                                    <%@ iconpopover { %>
                                    <% } %>
                                </div>
                            </div>
                            <div class="form-group  ">

                                <label for="uri" class="col-sm-2 control-label">URI</label>

                                <div class="col-sm-8">


                                    <div class="input-group">

                                        <span class="input-group-addon"><i class="fa fa-pencil fa-fw"></i></span>

                                        <input type="text" id="uri" name="uri" value="" class="form-control uri"
                                               placeholder="Input URI">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group  ">
                                <label for="roles" class="col-sm-2 control-label">Roles</label>
                                <div class="col-sm-8">
                                    <select class="form-control roles select2-hidden-accessible" style="width: 100%;"
                                            name="roles[]" multiple="" data-placeholder="Input Roles" tabindex="-1"
                                            aria-hidden="true">
                                        <option value="1">Administrator</option>
                                        <option value="2">Operator</option>
                                        <option value="3">SmallAdministrator</option>
                                    </select><input
                                        type="hidden" name="roles[]">
                                </div>
                            </div>
                        </div>
                        <!-- /.box-body -->
                        <div class="box-footer">
                            <div class="col-md-2"></div>
                            <div class="col-md-8">
                                <div class="btn-group pull-left">
                                    <button type="reset" class="btn btn-warning pull-right">Reset</button>
                                </div>
                                <div class="btn-group pull-right">
                                    <button type="submit" class="btn btn-info pull-right">Submit</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.box-body -->
            </div>
        </div>
    </div>

</section>
<script data-exec-on-popstate="">

    $(function () {

        $('#tree-5b405b7481760').nestable([]);

        $('.tree_branch_delete').click(function () {
            var id = $(this).data('id');
            swal({
                        title: "Are you sure to delete this item ?",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "Confirm",
                        closeOnConfirm: false,
                        cancelButtonText: "Cancel"
                    },
                    function () {
                        $.ajax({
                            method: 'post',
                            url: '/menu/delete?id=' + id,
                            data: {},
                            success: function (data) {
                                $.pjax.reload('#pjax-container');

                                if (typeof data === 'object') {
                                    if (data.status) {
                                        swal(data.message, '', 'success');
                                    } else {
                                        swal(data.message, '', 'error');
                                    }
                                }
                            }
                        });
                    });
        });

        $('.tree-5b405b7481760-save').click(function () {
            var serialize = $('#tree-5b405b7481760').nestable('serialize');

            $.post('/menu/order', {
                        _order: JSON.stringify(serialize)
                    },
                    function (data) {
                        $.pjax.reload('#pjax-container');
                        toastr.success('Save succeeded !');
                    });
        });

        $('.tree-5b405b7481760-refresh').click(function () {
            $.pjax.reload('#pjax-container');
            toastr.success('Refresh succeeded !');
        });

        $('.tree-5b405b7481760-tree-tools').on('click', function (e) {
            var target = $(e.target),
                    action = target.data('action');
            if (action === 'expand') {
                $('.dd').nestable('expandAll');
            }
            if (action === 'collapse') {
                $('.dd').nestable('collapseAll');
            }
        });


        $(".parent_id").select2({"allowClear": true, "placeholder": "Parent"});

        $('.icon').iconpicker({placement: 'bottomLeft'});

        $(".roles").select2({"allowClear": true, "placeholder": "Roles"});
    });
</script>
<script>
    $('.grid-per-pager').on("change", function (e) {
        console.log("changing...")
        $.pjax({url: this.value, container: '#pjax-container'});
    });
    $('.grid-refresh').on('click', function () {
        $.pjax.reload('#pjax-container');
        toastr.success('Refresh succeeded !');
    });
    // edit result notify
    // toastr.success('Refresh succeeded !');
    $.fn.editable.defaults.params = function (params) {
        params._token = LA.token;
        params._editable = 1;
        params._method = 'PUT';
        return params;
    };

    $.fn.editable.defaults.error = function (data) {
        var msg = '';
        if (data.responseJSON.errors) {
            $.each(data.responseJSON.errors, function (k, v) {
                msg += v + "\n";
            });
        }
        return msg
    };

    toastr.options = {
        closeButton: true,
        progressBar: true,
        showMethod: 'slideDown',
        timeOut: 4000
    };

    $.pjax.defaults.timeout = 5000;
    $.pjax.defaults.maxCacheLength = 0;
    $(document).pjax('a:not(a[target="_blank"])', {
        container: '#pjax-container'
    });

    NProgress.configure({parent: '#pjax-container'});

    $(document).on('pjax:timeout', function (event) {
        event.preventDefault();
    })

    $(document).on('submit', 'form[pjax-container]', function (event) {
        $.pjax.submit(event, '#pjax-container')
    });

    $(document).on("pjax:popstate", function () {

        $(document).one("pjax:end", function (event) {
            $(event.target).find("script[data-exec-on-popstate]").each(function () {
                $.globalEval(this.text || this.textContent || this.innerHTML || '');
            });
        });
    });

    $(document).on('pjax:send', function (xhr) {
        if (xhr.relatedTarget && xhr.relatedTarget.tagName && xhr.relatedTarget.tagName.toLowerCase() === 'form') {
            $submit_btn = $('form[pjax-container] :submit');
            if ($submit_btn) {
                $submit_btn.button('loading')
            }
        }
        NProgress.start();
    });

    $(document).on('pjax:complete', function (xhr) {
        if (xhr.relatedTarget && xhr.relatedTarget.tagName && xhr.relatedTarget.tagName.toLowerCase() === 'form') {
            $submit_btn = $('form[pjax-container] :submit');
            if ($submit_btn) {
                $submit_btn.button('reset')
            }
        }
        NProgress.done();
    });

    $(function () {
        $('.sidebar-menu li:not(.treeview) > a').on('click', function () {
            var $parent = $(this).parent().addClass('active');
            $parent.siblings('.treeview.active').find('> a').trigger('click');
            $parent.siblings().removeClass('active').find('li').removeClass('active');
        });

        $('[data-toggle="popover"]').popover();
    });

    // (function ($) {
    //     $.fn.admin = LA;
    //     $.admin = LA;
    //
    // })(jQuery);

    $('.grid-row-delete').unbind('click').click(function () {

        var id = $(this).data('id');

        swal({
                    title: "你确定要删除吗",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "确定",
                    closeOnConfirm: false,
                    cancelButtonText: "取消"
                },
                function () {
                    $.ajax({
                        method: 'post',
                        url: '/user/delete',
                        data: {
                            id: id
                        },
                        success: function (data) {
                            $.pjax.reload('#pjax-container');

                            if (typeof data === 'object') {
                                if (data.status) {
                                    swal(data.message, '', 'success');
                                } else {
                                    swal(data.message, '', 'error');
                                }
                            }
                        },
                        error: function (data) {
                            swal("删除失败", '', 'error');
                        }
                    });
                });
    });

    $('.grid-select-all').on('ifChanged', function (event) {
        if (this.checked) {
            $('.grid-row-checkbox').iCheck('check');
        } else {
            $('.grid-row-checkbox').iCheck('uncheck');
        }
    });
    $('.grid-select-all').iCheck({checkboxClass: 'icheckbox_minimal-blue'});

    $(function () {
        $('.grid-row-checkbox').iCheck({checkboxClass: 'icheckbox_minimal-blue'}).on('ifChanged', function () {
            if (this.checked) {
                $(this).closest('tr').css('background-color', '#ffffd5');
            } else {
                $(this).closest('tr').css('background-color', '');
            }
        });
    });
</script>
